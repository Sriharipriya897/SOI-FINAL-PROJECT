<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elder Care Companion - SOS</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .sos-btn {
            background-color: var(--error-color);
            color: white;
            width: 250px;
            height: 250px;
            border-radius: 50%;
            font-size: 3rem;
            border: 10px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 20px rgba(214, 69, 69, 0.6);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 50px auto;
            animation: pulse 2s infinite;
            cursor: pointer;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(214, 69, 69, 0.7);
            }

            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 20px rgba(214, 69, 69, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(214, 69, 69, 0);
            }
        }

        .alert-active {
            background-color: red !important;
            animation: flash 0.5s infinite;
        }

        @keyframes flash {
            0% {
                background-color: red;
            }

            50% {
                background-color: darkred;
            }

            100% {
                background-color: red;
            }
        }
    </style>
</head>

<body>

    <div class="container"
        style="background: radial-gradient(circle at top right, var(--secondary-color), transparent);">
        <div class="card fade-in" style="max-width: 600px; border-bottom: 8px solid var(--error-color);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <i class="fas fa-ambulance" style="color: var(--error-color); font-size: 2rem;"></i>
                    <h2 style="margin: 0; color: var(--text-color);">SOS Emergency</h2>
                </div>
                <button onclick="window.location.href='dashboard.html'" class="secondary"
                    style="width: auto; padding: 10px 20px;">
                    <i class="fas fa-arrow-left"></i> <span data-i18n="back">Back</span>
                </button>
            </div>

            <p class="mb-2" style="font-size: 1.1rem; color: var(--text-muted);">
                Press and hold the button below to send an emergency alert to your contacts.
            </p>

            <div style="position: relative; width: 260px; height: 260px; margin: 40px auto;">
                <button class="sos-btn" id="sosBtn" onmousedown="startHold()" onmouseup="endHold()"
                    ontouchstart="startHold()" ontouchend="endHold()"
                    style="margin: 0; width: 260px; height: 260px; background: var(--error-color); border: 8px solid white; box-shadow: 0 15px 35px rgba(231, 76, 60, 0.3);">
                    <i class="fas fa-ambulance" style="color: white; font-size: 4rem;"></i>
                    <span id="sosBtnText"
                        style="font-size: 1.8rem; display: block; margin-top: 10px; color: white; font-weight: 700;">SOS</span>
                </button>
                <svg class="hold-progress" width="260" height="260"
                    style="position: absolute; top: 0; left: 0; pointer-events: none; transform: rotate(-90deg);">
                    <circle cx="130" cy="130" r="125" fill="none" stroke="rgba(46, 204, 113, 0.1)" stroke-width="10">
                    </circle>
                    <circle id="holdCircle" cx="130" cy="130" r="125" fill="none" stroke="var(--primary-color)"
                        stroke-width="10" stroke-dasharray="785" stroke-dashoffset="785"
                        style="transition: stroke-dashoffset 0.1s linear;"></circle>
                </svg>
            </div>

            <div id="statusMsg" class="hidden"
                style="margin-top: 30px; padding: 20px; border-radius: 15px; background: #FFF5F5; border: 1px solid var(--error-color); font-weight: 600;">
                <div style="color: var(--error-color); font-size: 1.2rem; margin-bottom: 5px;">Alert Triggered!</div>
                <div style="font-size: 0.95rem; color: var(--text-color);">Opening communication channels...</div>
            </div>
        </div>
    </div>

    <!-- Siren Sound -->
    <audio id="sirenSound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock_short.ogg"
        preload="auto"></audio>

    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <script src="js/utils.js"></script>
    <script>
        let isSOSActive = false;

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const isAuto = urlParams.get('auto');
            if (isAuto === 'true') {
                // Auto trigger after a small delay to ensure page load
                setTimeout(() => {
                    const btn = document.getElementById('sosBtn');
                    if (btn) triggerSOS();
                }, 1000);
            }

            // Initialize Shake Detection
            initShakeDetection();

            // Initialize Volume Button Detection (Best Effort)
            initVolumeKeySOS();
        });

        // --- Long Press Logic ---
        let holdTimer;
        let holdProgress = 0;
        const HOLD_DURATION = 2000; // 2 seconds

        function startHold() {
            if (isSOSActive) {
                stopSOS();
                return;
            }
            holdProgress = 0;
            const circle = document.getElementById('holdCircle');
            const total = 754; // 2 * PI * 120

            holdTimer = setInterval(() => {
                holdProgress += 100;
                const offset = total - (total * (holdProgress / HOLD_DURATION));
                circle.style.strokeDashoffset = Math.max(0, offset);

                if (holdProgress >= HOLD_DURATION) {
                    clearInterval(holdTimer);
                    triggerSOS();
                }
            }, 100);
        }

        function endHold() {
            clearInterval(holdTimer);
            document.getElementById('holdCircle').style.strokeDashoffset = 754;
        }

        // --- Shake Detection Logic (Robust) ---
        let shakeThreshold = 25; // Increased from 15 for better accuracy
        let lastX = 0, lastY = 0, lastZ = 0;
        let lastUpdate = 0;
        let shakeCount = 0;
        let lastShakeTime = 0;

        function initShakeDetection() {
            if (window.DeviceMotionEvent) {
                window.addEventListener('devicemotion', (event) => {
                    const acceleration = event.accelerationIncludingGravity;
                    if (!acceleration) return;

                    const curTime = new Date().getTime();
                    if ((curTime - lastUpdate) > 100) {
                        const diffTime = curTime - lastUpdate;
                        lastUpdate = curTime;

                        const x = acceleration.x;
                        const y = acceleration.y;
                        const z = acceleration.z;

                        const speed = Math.sqrt(
                            Math.pow(x - lastX, 2) +
                            Math.pow(y - lastY, 2) +
                            Math.pow(z - lastZ, 2)
                        ) / diffTime * 10000;

                        if (speed > shakeThreshold * 150) { // Scaled threshold
                            const now = new Date().getTime();
                            // Debounce shakes (prevent multiple triggers for one shake)
                            if (now - lastShakeTime > 1000) {
                                shakeCount++;
                                lastShakeTime = now;
                                console.log("Shake detected! Count:", shakeCount);

                                // Trigger on 3 strong shakes within 5 seconds for robustness
                                if (shakeCount >= 3) {
                                    triggerSOS();
                                    shakeCount = 0;
                                }
                            }
                        }

                        // Reset count if too much time passes
                        if (new Date().getTime() - lastShakeTime > 5000) {
                            shakeCount = 0;
                        }

                        lastX = x;
                        lastY = y;
                        lastZ = z;
                    }
                }, false);
            } else {
                console.log("DeviceMotionEvent not supported on this device.");
            }
        }

        // --- Volume Key Logic (Best Effort) ---
        // Note: Browsers consume volume keys for system volume. 
        // This only works if the browser allows capturing media keys or specific key codes.
        let volumePressCount = 0;
        let lastVolumePressTime = 0;

        function initVolumeKeySOS() {
            document.addEventListener('keydown', (event) => {
                // Common codes for volume keys on some mobile browsers/remotes
                // 174: Volume Down, 175: Volume Up
                if (event.keyCode === 174 || event.key === 'AudioVolumeDown' ||
                    event.keyCode === 175 || event.key === 'AudioVolumeUp') {

                    const now = new Date().getTime();
                    if (now - lastVolumePressTime < 1000) {
                        volumePressCount++;
                    } else {
                        volumePressCount = 1;
                    }
                    lastVolumePressTime = now;

                    if (volumePressCount >= 2) {
                        triggerSOS();
                        volumePressCount = 0;
                    }
                }
            });
        }

        function triggerSOS() {
            if (isSOSActive) {
                stopSOS();
                return;
            }

            isSOSActive = true;

            // Store SOS status for chatbot context
            localStorage.setItem('elderSOSActive', 'true');
            localStorage.removeItem('elderSOSCancelled');
            localStorage.setItem('elderLastSOSTime', new Date().toISOString());

            document.body.classList.add('alert-active');

            const btnText = document.getElementById('sosBtnText');
            btnText.innerHTML = 'STOP';
            document.getElementById('sosBtn').querySelector('i').className = 'fas fa-stop';

            const status = document.getElementById('statusMsg');
            status.classList.remove('hidden');

            // Audio
            const audio = document.getElementById('sirenSound');
            audio.loop = true;
            audio.play().catch(console.error);

            // Precise AI Confirmation as requested
            const msg = "SOS alert sent successfully to your emergency contacts.";
            speak(msg);

            sendAlerts();

            // Log notification
            const notif = {
                title: 'SOS Alert Sent',
                message: 'Emergency SOS triggered at ' + new Date().toLocaleTimeString(),
                time: new Date().toISOString(),
                type: 'danger'
            };
            const notifications = JSON.parse(localStorage.getItem('elderNotifications') || '[]');
            notifications.unshift(notif);
            localStorage.setItem('elderNotifications', JSON.stringify(notifications));
        }

        function stopSOS() {
            isSOSActive = false;

            // Update SOS status for chatbot context
            localStorage.setItem('elderSOSActive', 'false');
            localStorage.setItem('elderSOSCancelled', 'true');

            document.body.classList.remove('alert-active');

            const btnText = document.getElementById('sosBtnText');
            btnText.innerHTML = 'SOS';
            document.getElementById('sosBtn').querySelector('i').className = 'fas fa-ambulance';

            document.getElementById('statusMsg').classList.add('hidden');

            const audio = document.getElementById('sirenSound');
            audio.pause();
            audio.currentTime = 0;

            // Allow re-trigger if needed, but remove query param to avoid loop on refresh
            window.history.replaceState({}, document.title, window.location.pathname);

            // Clear cancelled status after 5 minutes
            setTimeout(() => {
                localStorage.removeItem('elderSOSCancelled');
            }, 300000);
        }

        async function sendAlerts() {
            const profile = JSON.parse(localStorage.getItem('elderProfile') || '{}');
            const emailConfig = JSON.parse(localStorage.getItem('elderEmailConfig') || '{}');

            const userName = profile.name || 'Elderly User';
            const contactPhone = profile.contactPhone || '';
            const emergencyEmail = emailConfig.emergencyEmail || '';
            const time = new Date().toLocaleString();

            const statusMsg = document.getElementById('statusMsg');

            // Get user location if available
            let location = 'Location unavailable';
            if (navigator.geolocation) {
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 });
                    });
                    location = `Lat: ${position.coords.latitude.toFixed(4)}, Lon: ${position.coords.longitude.toFixed(4)}`;
                } catch (err) {
                    console.log('Location access denied or unavailable');
                }
            }

            const message = `ðŸš¨ SOS EMERGENCY!\n\nUser: ${userName}\nNeeds immediate help!\n\nTime: ${time}\nLocation: ${location}\n\nPlease contact them immediately.`;

            let emailSuccess = false;

            // 1. Send Email via EmailJS (if configured)
            if (emailConfig.serviceId && emailConfig.templateId && emailConfig.publicKey && emergencyEmail) {
                try {
                    statusMsg.innerHTML = '<div>Sending Email Alert...</div>';

                    // Initialize EmailJS
                    emailjs.init(emailConfig.publicKey);

                    // Send email
                    const response = await emailjs.send(
                        emailConfig.serviceId,
                        emailConfig.templateId,
                        {
                            to_email: emergencyEmail,
                            user_name: userName,
                            emergency_message: message,
                            timestamp: time,
                            location: location
                        }
                    );

                    console.log('Email sent successfully!', response);
                    emailSuccess = true;

                    // Update status message
                    statusMsg.innerHTML = `
                        <div style="color: green; font-weight: bold;">âœ“ Email alert sent to ${emergencyEmail}!</div>
                        <div style="font-size: 1rem; color: black; margin-top: 10px;">Opening WhatsApp as backup...</div>
                    `;

                } catch (error) {
                    console.error('EmailJS Error:', error);

                    // Show error but continue with fallback
                    statusMsg.innerHTML = `
                        <div style="color: #d64545; font-weight: bold;">âš  Automatic email failed.</div>
                        <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Error: ${error.text || error.message || 'Unknown error'}</div>
                        <div style="font-size: 1rem; color: black; margin-top: 10px;">Opening manual email and WhatsApp...</div>
                    `;

                    // Fallback to mailto
                    const encodedMsg = encodeURIComponent(message);
                    const mailLink = `mailto:${emergencyEmail}?subject=SOS Alert - ${userName}&body=${encodedMsg}`;
                    setTimeout(() => window.location.href = mailLink, 3000);
                }
            } else {
                // No EmailJS configured or missing emergency email
                console.log('EmailJS not fully configured.');

                statusMsg.innerHTML = `
                    <div style="color: orange; font-weight: bold;">âš  Alert system not fully configured.</div>
                    <div style="font-size: 1rem; color: black; margin-top: 10px;">Opening manual email and WhatsApp...</div>
                `;

                const encodedMsg = encodeURIComponent(message);
                const mailLink = `mailto:${emergencyEmail}?subject=SOS Alert - ${userName}&body=${encodedMsg}`;
                setTimeout(() => window.location.href = mailLink, 2000);
            }

            // 2. WhatsApp Web Link (always send as backup)
            const encodedMsg = encodeURIComponent(message);
            let waLink = `https://wa.me/?text=${encodedMsg}`;
            if (contactPhone) {
                waLink = `https://wa.me/${contactPhone.replace(/\D/g, '')}?text=${encodedMsg}`;
            }

            setTimeout(() => {
                window.open(waLink, '_blank');
            }, 1000);
        }
    </script>
</body>

</html>