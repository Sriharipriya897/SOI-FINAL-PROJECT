<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elder Care Companion - Medicines</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>

    <div class="container"
        style="background: radial-gradient(circle at top left, var(--secondary-color), transparent);">
        <div class="card fade-in" style="max-width: 850px; width: 100%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <i class="fas fa-pills" style="color: var(--primary-color); font-size: 2rem;"></i>
                    <h2 style="margin: 0; color: var(--text-color);">Medication Schedule</h2>
                </div>
                <button onclick="window.location.href='dashboard.html'" class="secondary"
                    style="width: auto; padding: 10px 20px;">
                    <i class="fas fa-arrow-left"></i> <span data-i18n="back">Back</span>
                </button>
            </div>

            <!-- Add Medicine Form -->
            <div class="card" style="background: rgba(0,0,0,0.03); margin-bottom: 20px; text-align: left;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 class="mb-1">Add Reminder</h3>
                    <button type="button" onclick="testAudio()" class="secondary"
                        style="padding: 5px 10px; font-size: 0.8rem;">
                        <i class="fas fa-volume-up"></i> Test Sound
                    </button>
                </div>
                <form id="medForm">
                    <input type="text" id="medName" placeholder="Medicine Name (e.g., Metformin)" required>
                    <input type="text" id="medDosage" placeholder="Dosage (e.g., 1 tablet after food)" required>
                    <input type="time" id="medTime" required>

                    <button type="submit" data-i18n="save">Save</button>
                </form>
            </div>

            <!-- List -->
            <div id="medList" style="text-align: left;">
                <!-- Items will be injected here -->
            </div>

            <button onclick="clearAllMedicines()" class="alert"
                style="margin-top: 20px; background-color: var(--error-color);">
                <i class="fas fa-trash"></i> Delete All Medicines
            </button>
        </div>
    </div>

    <!-- Alarm Audio -->
    <audio id="alarmSound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"
        loop></audio>

    <!-- Custom Alarm Modal -->
    <div id="alarmModal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center;">
        <div class="card"
            style="background: white; padding: 50px; text-align: center; border-radius: 20px; animation: pulse 1s infinite; max-width: 90%;">
            <i class="fas fa-pills" style="font-size: 5rem; color: var(--primary-color); margin-bottom: 30px;"></i>
            <h2 style="color: var(--text-color); margin-bottom: 20px; font-size: 2rem;">Medicine Time!</h2>
            <p id="alarmMsg" style="font-size: 1.5rem; margin-bottom: 40px; color: var(--text-color);">Please take
                your medicine.</p>
            <button onclick="stopAlarm()" class="primary"
                style="font-size: 1.5rem; padding: 20px 50px; border-radius: 50px; width: 100%;">
                <i class="fas fa-check"></i> I Have Taken It
            </button>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script>
        let isAlarmPlaying = false;

        document.addEventListener('DOMContentLoaded', () => {
            loadReminders();
            // Check immediately in case we opened it right on time
            checkReminders();
            // Then check every minute
            setInterval(checkReminders, 60000);
        });

        const medForm = document.getElementById('medForm');
        medForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('medName').value;
            const dosage = document.getElementById('medDosage').value;
            const time = document.getElementById('medTime').value;

            const reminder = {
                id: Date.now(),
                name,
                dosage,
                time
            };

            const reminders = getReminders();
            reminders.push(reminder);
            localStorage.setItem('elderReminders', JSON.stringify(reminders));

            medForm.reset();
            loadReminders();
        });

        function getReminders() {
            return JSON.parse(localStorage.getItem('elderReminders') || '[]');
        }

        function loadReminders() {
            const list = document.getElementById('medList');
            const reminders = getReminders();

            list.innerHTML = '';
            if (reminders.length === 0) {
                list.innerHTML = '<p class="text-center" style="color:var(--secondary-color)">No reminders set.</p>';
                return;
            }

            reminders.sort((a, b) => a.time.localeCompare(b.time));

            reminders.forEach(r => {
                const item = document.createElement('div');
                item.className = 'card fade-in';
                item.style.marginBottom = '15px';
                item.style.padding = '25px';
                item.style.display = 'flex';
                item.style.justifyContent = 'space-between';
                item.style.alignItems = 'center';
                item.style.borderLeft = '6px solid var(--primary-color)';
                // Override card width for list items
                item.style.maxWidth = '100%';

                const takenText = r.lastTaken === r.time
                    ? `<span style="color:var(--success-color); font-weight:bold;"><i class="fas fa-check-circle"></i> Taken</span>`
                    : '';

                item.innerHTML = `
                    <div>
                        <strong style="font-size: 1.2rem;">${r.time}</strong>
                        <h4 style="margin: 5px 0;">${r.name}</h4>
                        <p>${r.dosage} ${takenText}</p>
                    </div>
                    <button class="alert" onclick="deleteReminder(${r.id})" style="width: auto; padding: 8px 15px;">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                list.appendChild(item);
            });
        }

        window.deleteReminder = function (id) {
            let reminders = getReminders();
            reminders = reminders.filter(r => r.id !== id);
            localStorage.setItem('elderReminders', JSON.stringify(reminders));
            loadReminders();
        }

        function checkReminders() {
            if (isAlarmPlaying) return; // Don't trigger overlapping alarms

            const now = new Date();
            const currentHours = String(now.getHours()).padStart(2, '0');
            const currentMinutes = String(now.getMinutes()).padStart(2, '0');
            const currentTime = `${currentHours}:${currentMinutes}`;

            const reminders = getReminders();
            const matching = reminders.find(r => r.time === currentTime && r.lastTaken !== currentTime);

            if (matching) {
                playAlert(matching);
            }
        }

        function playAlert(reminder) {
            isAlarmPlaying = true;
            const audio = document.getElementById('alarmSound');
            audio.currentTime = 0;
            audio.play().catch(e => {
                console.log('Audio autoplay blocked', e);
            });

            const msg = `Time to take medicine: ${reminder.name} (${reminder.dosage})`;
            document.getElementById('alarmMsg').innerText = msg;
            document.getElementById('alarmModal').style.display = 'flex';

            // Speak naturally
            speak(msg);
            // Repeat speak every 5 seconds if still playing (simple loop)
            const speakInterval = setInterval(() => {
                if (!isAlarmPlaying) clearInterval(speakInterval);
                else speak("Please take medicine " + reminder.name);
            }, 8000);
        }

        function stopAlarm() {
            const audio = document.getElementById('alarmSound');
            audio.pause();
            audio.currentTime = 0;
            document.getElementById('alarmModal').style.display = 'none';
            isAlarmPlaying = false;

            // Mark as taken
            const now = new Date();
            const currentHours = String(now.getHours()).padStart(2, '0');
            const currentMinutes = String(now.getMinutes()).padStart(2, '0');
            const currentTime = `${currentHours}:${currentMinutes}`;

            let reminders = getReminders();
            // Find just-active reminders
            reminders = reminders.map(r => {
                if (r.time === currentTime) {
                    return { ...r, lastTaken: currentTime };
                }
                return r;
            });
            localStorage.setItem('elderReminders', JSON.stringify(reminders));
            loadReminders(); // Refresh list to show checkmark
            speak("Thank you. Medicine marked as taken.");
        }

        function testAudio() {
            const audio = document.getElementById('alarmSound');
            audio.currentTime = 0;
            audio.play().catch(e => alert("Audio blocked. Click the page first!"));
            setTimeout(() => { audio.pause(); }, 3000);
            speak("Testing alarm sound.");
        }

        function clearAllMedicines() {
            localStorage.removeItem('elderReminders');
            loadReminders();

            const btn = document.querySelector('button[onclick="clearAllMedicines()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> All Deleted';
            setTimeout(() => btn.innerHTML = originalText, 2000);
        }
    </script>
</body>

</html>