<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elder Care - Nurse Portal</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .portal-header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 12px 12px 0 0;
        }
    </style>
</head>

<body style="background: #f0f2f5;">
    <div class="container">
        <div class="card" style="max-width: 900px; padding: 0; overflow: hidden;">
            <div class="portal-header">
                <h2><i class="fas fa-user-nurse"></i> Hospital / Nurse Portal</h2>
                <p>Authorized Access Only</p>
            </div>

            <div style="padding: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Authoritative Prescriptions -->
                    <div class="card"
                        style="text-align: left; background: var(--card-bg); color: var(--text-color); border: 1px solid #ddd;">
                        <h3><i class="fas fa-prescription"></i> Add Authoritative Prescription</h3>
                        <p class="mb-1" style="font-size: 0.8rem; color: #666;">This will automatically sync with the
                            elder's reminders.</p>
                        <form id="prescForm">
                            <input type="text" id="pName" placeholder="Medicine Name" required>
                            <input type="text" id="pDosage" placeholder="Dosage (e.g. 1-0-1)" required>
                            <input type="time" id="pTime" required>
                            <button type="submit" class="primary">Add & Sync</button>
                        </form>
                    </div>

                    <!-- Vitals Entry -->
                    <div class="card"
                        style="text-align: left; background: var(--card-bg); color: var(--text-color); border: 1px solid #ddd;">
                        <h3><i class="fas fa-heartbeat"></i> Update Vitals</h3>
                        <form id="vitalsForm">
                            <input type="number" id="vSys" placeholder="Systolic (e.g. 120)" required>
                            <input type="number" id="vDia" placeholder="Diastolic (e.g. 80)" required>
                            <input type="number" id="vSugar" placeholder="Blood Sugar (mg/dL)">
                            <button type="submit" class="secondary">Update & Sync</button>
                        </form>
                    </div>
                </div>

                <!-- Current Prescriptions List -->
                <div class="card" style="margin-top: 20px; text-align: left;">
                    <h3><i class="fas fa-list-ul"></i> Current Prescriptions</h3>
                    <div id="prescList" style="margin-top: 15px;">
                        <!-- List of medicines will be injected here -->
                    </div>
                </div>

                <!-- Summary & Reports -->
                <div class="card" style="margin-top: 20px; text-align: left;">
                    <h3><i class="fas fa-file-medical"></i> Elder Health Summary</h3>
                    <div id="nurseSummary" style="margin-bottom: 15px;">
                        <!-- Summary injected here -->
                    </div>
                    <button onclick="window.location.href='health.html'" class="secondary">Go to Health
                        Analytics</button>
                </div>

                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="window.location.href='dashboard.html'" class="alert">Exit Nurse Portal</button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script>
        let editingMedId = null;

        document.addEventListener('DOMContentLoaded', () => {
            updateNurseSummary();
            loadPrescriptions();
        });

        document.getElementById('prescForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const reminders = JSON.parse(localStorage.getItem('elderReminders') || '[]');
            const name = document.getElementById('pName').value;
            const dosage = document.getElementById('pDosage').value;
            const time = document.getElementById('pTime').value;

            if (editingMedId) {
                // Update existing
                const index = reminders.findIndex(r => r.id === editingMedId);
                if (index !== -1) {
                    reminders[index] = { ...reminders[index], name, dosage, time };
                }
                editingMedId = null;
                document.querySelector('#prescForm button').innerText = 'Add & Sync';
            } else {
                // Add new
                reminders.push({
                    id: Date.now(),
                    name,
                    dosage,
                    time,
                    source: 'Nurse/Hospital'
                });
            }

            localStorage.setItem('elderReminders', JSON.stringify(reminders));
            alert("Prescription synced successfully.");
            e.target.reset();
            loadPrescriptions();
        });

        function loadPrescriptions() {
            const reminders = JSON.parse(localStorage.getItem('elderReminders') || '[]');
            const container = document.getElementById('prescList');
            container.innerHTML = '';

            if (reminders.length === 0) {
                container.innerHTML = '<p style="color: #666; font-size: 0.9rem;">No prescriptions added yet.</p>';
                return;
            }

            reminders.forEach(r => {
                const item = document.createElement('div');
                item.className = 'card';
                item.style.padding = '10px';
                item.style.marginBottom = '10px';
                item.style.display = 'flex';
                item.style.justifyContent = 'space-between';
                item.style.alignItems = 'center';
                item.style.background = 'var(--card-bg)';
                item.style.color = 'var(--text-color)';
                item.style.border = '1px solid #eee';

                item.innerHTML = `
                    <div>
                        <strong>${r.name}</strong> - ${r.dosage}<br>
                        <small><i class="fas fa-clock"></i> ${r.time} ${r.source ? `(${r.source})` : ''}</small>
                    </div>
                    <div>
                        <button onclick="editPrescription(${r.id})" style="padding: 5px 10px; font-size: 0.8rem; background: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deletePrescription(${r.id})" style="padding: 5px 10px; font-size: 0.8rem; background: #d64545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function deletePrescription(id) {
            let reminders = JSON.parse(localStorage.getItem('elderReminders') || '[]');
            reminders = reminders.filter(r => r.id !== id);
            localStorage.setItem('elderReminders', JSON.stringify(reminders));
            loadPrescriptions();
        }

        function editPrescription(id) {
            const reminders = JSON.parse(localStorage.getItem('elderReminders') || '[]');
            const med = reminders.find(r => r.id === id);
            if (med) {
                document.getElementById('pName').value = med.name;
                document.getElementById('pDosage').value = med.dosage;
                document.getElementById('pTime').value = med.time;
                editingMedId = id;
                document.querySelector('#prescForm button').innerText = 'Update & Sync';
                document.getElementById('pName').focus();
            }
        }

        document.getElementById('vitalsForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const logs = JSON.parse(localStorage.getItem('elderHealth') || '[]');
            logs.push({
                timestamp: Date.now(),
                date: new Date().toLocaleDateString(),
                sys: document.getElementById('vSys').value,
                dia: document.getElementById('vDia').value,
                sugar: document.getElementById('vSugar').value
            });
            localStorage.setItem('elderHealth', JSON.stringify(logs));
            alert("Vitals synced successfully.");
            e.target.reset();
            updateNurseSummary();
        });

        function updateNurseSummary() {
            const profile = JSON.parse(localStorage.getItem('elderProfile') || '{}');
            const data = JSON.parse(localStorage.getItem('elderHealth') || '[]');
            const container = document.getElementById('nurseSummary');

            if (data.length === 0) {
                container.innerHTML = `<p>Elder: <strong>${profile.name || 'N/A'}</strong>. No health logs available yet.</p>`;
            } else {
                const latest = data[data.length - 1];
                container.innerHTML = `
                    <p>Elder: <strong>${profile.name}</strong> (Age: ${profile.age})</p>
                    <p>Latest BP: <strong>${latest.sys}/${latest.dia}</strong> (Logged on ${latest.date})</p>
                    <p>Target: 120/80. Status: ${parseInt(latest.sys) > 130 ? '<span style="color:red">Needs Attention</span>' : '<span style="color:green">Stable</span>'}</p>
                `;
            }
        }
    </script>
</body>

</html>