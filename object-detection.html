<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elder Care Companion - Object Detection</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- TensorFlow.js will be loaded dynamically -->

    <style>
        #camContainer {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
        }

        video {
            width: 100%;
            border-radius: 12px;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="card" style="max-width: 800px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 data-i18n="object_detection">Object Detection</h2>
                <button onclick="window.location.href='dashboard.html'" class="secondary"
                    style="width: auto; padding: 10px 15px;">
                    <i class="fas fa-arrow-left"></i> <span data-i18n="back">Back</span>
                </button>
            </div>

            <p class="mb-2">Point camera at objects to identify them.</p>

            <div id="loadingMsg">
                <i class="fas fa-spinner fa-spin"></i> Initializing AI Engine...
            </div>

            <div id="camContainer" class="hidden">
                <video id="webcam" autoplay playsinline muted></video>
                <canvas id="canvas"></canvas>
            </div>

            <button id="startBtn" onclick="enableCam()" class="hidden" style="margin-top:20px;">
                <i class="fas fa-camera"></i> Start Camera
            </button>

            <div id="aiStatus" class="hidden"
                style="margin-top: 15px; padding: 10px; border-radius: 8px; background: #f8f9fa; border-left: 4px solid #667eea; font-size: 0.9rem;">
                <i class="fas fa-brain" style="color: #667eea;"></i> <strong>AI Status:</strong> <span
                    id="statusText">Active & Monitoring</span>
            </div>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script>
        let model = undefined;
        let lastSpoken = "";
        let lastSpokenTime = 0;
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const loadingMsg = document.getElementById('loadingMsg');
        const startBtn = document.getElementById('startBtn');

        // Check for Secure Context
        if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            console.warn("Camera and AI features might be restricted on non-secure (HTTP) origins.");
        }

        function updateStatus(msg, type = 'info') {
            if (type === 'error') {
                loadingMsg.innerHTML = `
                    <div style="color: var(--error-color); font-weight: bold;">
                        <i class="fas fa-exclamation-triangle"></i> ${msg}
                    </div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                        Check your internet connection.
                    </div>
                    <button onclick="location.reload()" class="secondary" style="margin-top: 15px; width: auto; padding: 8px 20px;">
                        <i class="fas fa-sync"></i> Retry
                    </button>
                `;
            } else {
                loadingMsg.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${msg}`;
            }
        }

        // Helper to load a script from a list of mirrors
        async function loadScriptWithFallback(mirrors) {
            for (const src of mirrors) {
                try {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = src;
                        script.onload = resolve;
                        script.onerror = () => reject(new Error(`Failed to load ${src}`));
                        document.head.appendChild(script);
                    });
                    console.log(`Loaded: ${src}`);
                    return; // Success!
                } catch (e) {
                    console.warn(e.message, "Trying next mirror...");
                    continue;
                }
            }
            throw new Error("All mirrors failed for script.");
        }

        async function loadAIModel() {
            updateStatus("Initializing AI Engine...");
            startBtn.classList.add('hidden');

            try {
                // 1. Load TensorFlow.js
                if (typeof tf === 'undefined') {
                    updateStatus("Downloading TensorFlow.js (60s timeout)...");
                    await loadScriptWithFallback([
                        "https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js",
                        "https://unpkg.com/@tensorflow/tfjs@3.18.0/dist/tf.min.js",
                        "https://cdnjs.cloudflare.com/ajax/libs/tensorflow/3.18.0/tf.min.js"
                    ]);
                }

                // 2. Initialize Backend
                await tf.ready();

                // 3. Load COCO-SSD
                if (typeof cocoSsd === 'undefined') {
                    updateStatus("Downloading Object Detection...");
                    await loadScriptWithFallback([
                        "https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js",
                        "https://unpkg.com/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js",
                        "https://cdnjs.cloudflare.com/ajax/libs/tensorflow-models/coco-ssd/2.2.2/coco-ssd.min.js"
                    ]);
                }

                // 4. Load Model Weights
                updateStatus("Loading Vision Model (Lite version)...");

                // Add a longer timeout for the model weights (60s)
                // Use lite_mobilenet_v2 for faster loading on mobile devices
                const modelLoadPromise = cocoSsd.load({ base: 'lite_mobilenet_v2' });
                const timeoutPromise = new Promise((_, reject) =>
                    setTimeout(() => reject(new Error("Network timeout")), 60000)
                );

                model = await Promise.race([modelLoadPromise, timeoutPromise]);
                console.log("Model loaded successfully.");

                loadingMsg.classList.add('hidden');
                startBtn.classList.remove('hidden');

            } catch (err) {
                console.error("Model Load Error:", err);
                let errorText = "Network too slow.";
                if (err.message.includes("timeout")) errorText = "Connection timed out.";
                if (err.message.includes("All mirrors failed")) errorText = "Unable to download AI components.";

                loadingMsg.innerHTML = `
                    <div style="color: var(--error-color); font-weight: bold;">
                        <i class="fas fa-wifi"></i> ${errorText}
                    </div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                        We couldn't reach the AI server. <br>
                        Please check your internet connection.
                    </div>
                    <button onclick="loadAIModel()" class="secondary" style="margin-top: 15px; width: auto; padding: 8px 20px;">
                        <i class="fas fa-sync"></i> Use Backup Connection
                    </button>
                    <button onclick="window.location.reload()" class="secondary" style="margin-top: 5px; width: auto; font-size: 0.8rem; border:none; color: var(--primary-color);">
                       Reload Page
                    </button>
                `;
            }
        }

        // Initial Load
        loadAIModel();

        function enableCam() {
            if (!model) return;

            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert("Your browser does not support camera access or is blocking it.");
                return;
            }

            const constraints = {
                video: {
                    facingMode: 'environment', // Prefer back camera
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                },
                audio: false
            };

            navigator.mediaDevices.getUserMedia(constraints).then(stream => {
                video.srcObject = stream;
                // Wait for video to actually play before predicting
                video.onloadedmetadata = () => {
                    video.play();
                    predictWebcam();
                };
                document.getElementById('camContainer').classList.remove('hidden');
                document.getElementById('aiStatus').classList.remove('hidden');
                startBtn.classList.add('hidden');
            }).catch(err => {
                console.error("Camera Error:", err);
                alert("Could not access camera: " + err.message);
            });
        }

        function predictWebcam() {
            // Ensure video is ready
            if (video.readyState < 2) {
                requestAnimationFrame(predictWebcam);
                return;
            }

            // Sync canvas size to video size
            if (canvas.width !== video.videoWidth || canvas.height !== video.videoHeight) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
            }

            model.detect(video).then(predictions => {
                try {
                    renderPredictions(predictions);
                } catch (e) {
                    console.error("Render Error:", e);
                }
                requestAnimationFrame(predictWebcam);
            });
        }

        let lastDetectedObjectHash = "";

        function renderPredictions(predictions) {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

            // Font settings
            ctx.font = '24px sans-serif';
            ctx.textBaseline = 'top';

            const settings = getSettings();
            const lang = settings.lang || 'en';

            // Store detected objects for chatbot context
            const detectedObjectNames = [];

            predictions.forEach(prediction => {
                const x = prediction.bbox[0];
                const y = prediction.bbox[1];
                const width = prediction.bbox[2];
                const height = prediction.bbox[3];

                // Draw bounding box
                ctx.strokeStyle = '#00FFFF';
                ctx.lineWidth = 4;
                ctx.strokeRect(x, y, width, height);

                // Translate Label
                let label = prediction.class;
                if (lang === 'ta' && COCO_TRANSLATIONS && COCO_TRANSLATIONS[label]) {
                    label = COCO_TRANSLATIONS[label];
                }

                // Store original English name for chatbot
                detectedObjectNames.push(prediction.class);

                // Draw Background
                ctx.fillStyle = '#00FFFF';
                const textWidth = ctx.measureText(label).width;
                ctx.fillRect(x, y, textWidth + 10, 30);

                // Draw Text
                ctx.fillStyle = '#000000';
                ctx.fillText(label, x + 5, y + 2);

                // Speak
                debounceSpeak(label, lang);
            });

            // Save to localStorage ONLY if detection changed (throttle)
            const uniqueObjects = [...new Set(detectedObjectNames)].sort();
            const objectHash = uniqueObjects.join(',');

            if (objectHash !== lastDetectedObjectHash) {
                lastDetectedObjectHash = objectHash;

                if (uniqueObjects.length > 0) {
                    localStorage.setItem('elderDetectedObjects', JSON.stringify(uniqueObjects));
                    localStorage.setItem('elderLastDetectionTime', new Date().toISOString());

                    // Also save to recent history (persists longer)
                    localStorage.setItem('elderRecentObjects', JSON.stringify(uniqueObjects));
                    localStorage.setItem('elderRecentTime', new Date().toISOString());
                    console.log('✅ Detection stored:', uniqueObjects);
                } else {
                    localStorage.removeItem('elderDetectedObjects');
                    console.log('⚪ Detection cleared');
                }
            }
        }

        function debounceSpeak(label, lang) {
            const now = Date.now();
            // Don't repeat same word within 4 seconds
            if (lastSpoken !== label || (now - lastSpokenTime) > 4000) {
                lastSpoken = label;
                lastSpokenTime = now;

                // Construct Natural Sentence
                let sentence = "";
                if (lang === 'ta') {
                    sentence = `${label} தெரிகிறது`; // "Object is seen"
                } else {
                    sentence = `I see a ${label}`;
                }

                speak(sentence, lang === 'ta' ? 'ta-IN' : 'en-US');
            }
        }
    </script>
</body>

</html>